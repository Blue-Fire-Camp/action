name: auto_merge

on:
  schedule:
    - cron: "*/20 * * * *"  # runs every hour at minute 30 UTC
  workflow_dispatch: 
permissions:
  contents: write
  pull-requests: write
jobs:
  auto-merge:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List open PRs
        id: prs
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            // Return PR numbers as JSON string
             return prs.data.map(pr => pr.number).join(",");

      - name: Merge PRs with enough approvals
        uses: actions/github-script@v7
        env:
          PR: ${{ steps.prs.outputs.result }}
        with:
          script: |
            const MIN_APPROVALS = 5; // set the threshold you want
            const REQUIRED_APPROVERS = ["user1", "user2"]; // List of required GitHub usernames
            
            console.log("üîç Raw PR list:", process.env.PR);
            const prNumbers = JSON.parse(process.env.PR || "[]");
            console.log("üìã Parsed PR numbers:", prNumbers);

            for (const pr_number of prNumbers) {
              const reviews = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number,
              });
              const latestReviews = {};
              for (const r of reviews.data) {
              latestReviews[r.user.login] = r.state;
              }
              const approvedCount = Object.values(latestReviews).filter(r => r === "APPROVED").length;
              const hasRequiredApprovers = REQUIRED_APPROVERS.every(user => approvers.includes(user));
               
              if (approvedCount >= MIN_APPROVALS && hasRequiredApprovers) {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr_number,
                  merge_method: "squash" // choose: squash, merge, or rebase
                });
                console.log(`‚úÖ Merged PR #${pr_number} with ${approvedCount} approvals.`);
              } else {
                console.log(`‚ö†Ô∏è PR #${pr_number} has only ${approvedCount} approvals (<${MIN_APPROVALS}), skipping.`);
              }
            }
